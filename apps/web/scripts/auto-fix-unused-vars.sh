#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
# –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å _ –∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º

echo "üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö..."

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
FILES=$(pnpm --filter web lint 2>&1 | grep -E "error.*no-unused-vars.*is defined but never used" | cut -d: -f1 | sort -u)

if [ -z "$FILES" ]; then
  echo "‚úÖ –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏"
  exit 0
fi

echo "üìù –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: $(echo "$FILES" | wc -l)"

# –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
for FILE in $FILES; do
  if [ ! -f "$FILE" ]; then
    continue
  fi
  
  echo "üîç –û–±—Ä–∞–±–æ—Ç–∫–∞: $FILE"
  
  # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
  UNUSED=$(pnpm --filter web lint 2>&1 | grep "$FILE" | grep -E "is defined but never used" | sed -E "s/.*'([^']+)' is defined but never used.*/\1/" | sort -u)
  
  for VAR in $UNUSED; do
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å _
    if [[ "$VAR" =~ ^_ ]]; then
      continue
    fi
    
    # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –Ω–∞ _${VAR} –≤ —Ñ–∞–π–ª–µ
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º sed –¥–ª—è –∑–∞–º–µ–Ω—ã, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    echo "   ‚Üí –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: $VAR ‚Üí _$VAR"
    
    # –ó–∞–º–µ–Ω—è–µ–º –≤ –∏–º–ø–æ—Ä—Ç–∞—Ö
    sed -i.bak "s/import { $VAR\([^}]*\)/import { _$VAR\1/g" "$FILE" 2>/dev/null
    sed -i.bak "s/, $VAR\([^}]*\)/, _$VAR\1/g" "$FILE" 2>/dev/null
    sed -i.bak "s/$VAR,/_$VAR,/g" "$FILE" 2>/dev/null
    
    # –ó–∞–º–µ–Ω—è–µ–º –≤ –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    sed -i.bak "s/const $VAR =/const _$VAR =/g" "$FILE" 2>/dev/null
    sed -i.bak "s/let $VAR =/let _$VAR =/g" "$FILE" 2>/dev/null
    sed -i.bak "s/var $VAR =/var _$VAR =/g" "$FILE" 2>/dev/null
    
    # –£–¥–∞–ª—è–µ–º backup —Ñ–∞–π–ª—ã
    rm -f "${FILE}.bak"
  done
done

echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìù –ó–∞–ø—É—Å—Ç–∏—Ç–µ 'pnpm --filter web lint' –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"



