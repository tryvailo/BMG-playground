#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –±–∏–ª–¥–æ–≤

set -e

echo "üöÄ –ù–∞—á–∞–ª–æ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫..."
echo ""

# –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑
echo "üìä –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."
TOTAL_ERRORS=$(pnpm --filter web lint 2>&1 | grep -c "error" || echo "0")
echo "   –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: $TOTAL_ERRORS"
echo ""

# –®–∞–≥ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
echo "üîß –®–∞–≥ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."
pnpm --filter web lint --fix || true
echo "   ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
echo ""

# –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ catch –±–ª–æ–∫–æ–≤
echo "üîß –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ catch –±–ª–æ–∫–æ–≤..."
if [ -f "./apps/web/scripts/fix-catch-blocks.sh" ]; then
  ./apps/web/scripts/fix-catch-blocks.sh || true
  echo "   ‚úÖ Catch –±–ª–æ–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
else
  echo "   ‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç fix-catch-blocks.sh –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
echo "üìä –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞..."
rm -rf .eslintcache apps/web/.eslintcache 2>/dev/null || true
NEW_ERRORS=$(pnpm --filter web lint --no-cache 2>&1 | grep -c "error" || echo "0")
FIXED=$((TOTAL_ERRORS - NEW_ERRORS))

echo "   –ë—ã–ª–æ –æ—à–∏–±–æ–∫: $TOTAL_ERRORS"
echo "   –°—Ç–∞–ª–æ –æ—à–∏–±–æ–∫: $NEW_ERRORS"
echo "   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: $FIXED"
echo ""

# –®–∞–≥ 5: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
if [ "$NEW_ERRORS" -lt 100 ]; then
  echo "‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ú–æ–∂–Ω–æ –∫–æ–º–º–∏—Ç–∏—Ç—å –≤—Å–µ —Å—Ä–∞–∑—É"
  echo "   –û—Å—Ç–∞–ª–æ—Å—å –æ—à–∏–±–æ–∫: $NEW_ERRORS (< 100)"
elif [ "$NEW_ERRORS" -lt 200 ]; then
  echo "‚ö†Ô∏è  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –†–∞–∑–±–∏—Ç—å –Ω–∞ 2-3 –∫–æ–º–º–∏—Ç–∞"
  echo "   –û—Å—Ç–∞–ª–æ—Å—å –æ—à–∏–±–æ–∫: $NEW_ERRORS (100-200)"
else
  echo "üî¥ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –†–∞–∑–±–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–º–∏—Ç–æ–≤"
  echo "   –û—Å—Ç–∞–ª–æ—Å—å –æ—à–∏–±–æ–∫: $NEW_ERRORS (> 200)"
  echo ""
  echo "   –¢–æ–ø-10 —Ñ–∞–π–ª–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏:"
  pnpm --filter web lint --no-cache 2>&1 | grep -E "error" | cut -d: -f1 | sort | uniq -c | sort -rn | head -10
fi

echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ: pnpm --filter web lint --no-cache"
echo "   2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TypeScript: pnpm --filter web typecheck"
echo "   3. –ï—Å–ª–∏ –≤—Å–µ –æ–∫ - –∫–æ–º–º–∏—Ç–∏—Ç—å: git add -A && git commit -m 'fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫' && git push"


