# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –ø–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞, –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –≤ –¥–∞—à–±–æ—Ä–¥, –Ω–æ –≤ –∏—Ç–æ–≥–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (`auth.users` –∏–ª–∏ `accounts`).

### –°–∏–º–ø—Ç–æ–º—ã:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –≤ –¥–∞—à–±–æ—Ä–¥ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- ‚ùå –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î
- ‚ùå –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `accounts` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

## üîç –ü—Ä–∏—á–∏–Ω–∞

–¢—Ä–∏–≥–≥–µ—Ä `on_auth_user_created` –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ `accounts` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `auth.users`, –Ω–æ:

1. **–¢—Ä–∏–≥–≥–µ—Ä –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å** –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö:
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ admin API
   - –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏)
   - –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è

2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏** –≤ –∫–æ–¥–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞:
   - –ö–æ–¥ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–∑–¥–∞–ª—Å—è –ª–∏ account –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - –ï—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, account –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ (—Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞), –Ω–æ account –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏**:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –¢—Ä–∏–≥–≥–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å account –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–¥–µ—Ç –Ω–µ —Ç–∞–∫, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ **—è–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ account** –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞:

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (`signUp`), –∫–æ–¥ —Ç–µ–ø–µ—Ä—å:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ account –≤ –ë–î
2. –ï—Å–ª–∏ account –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–æ–∑–¥–∞–µ—Ç –µ–≥–æ –≤—Ä—É—á–Ω—É—é
3. –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 2. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

**–§–∞–π–ª:** `apps/web/app/[locale]/onboarding/page.tsx`

**–§—É–Ω–∫—Ü–∏–∏:**
- `handleCreateAccount` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ account
- `handleCreateAccountThenPricing` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ account

**–ö–æ–¥:**
```typescript
// CRITICAL: Ensure account exists in database
// The trigger should create it, but we verify and create if needed
// This prevents the issue where user can login but account doesn't exist
try {
    const { data: existingAccount, error: accountCheckError } = await client
        .from('accounts')
        .select('id')
        .eq('id', userId)
        .maybeSingle();

    if (!existingAccount) {
        console.log('[Onboarding] Account not found, creating...');
        const { error: accountError } = await client
            .from('accounts')
            .insert({
                id: userId,
                name: email.split('@')[0] || 'User',
                email: email,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
            });

        if (accountError) {
            console.error('[Onboarding] Error creating account:', accountError);
            // Check if it's a conflict error (account already exists)
            if (!accountError.message?.includes('duplicate') && !accountError.message?.includes('unique')) {
                throw new Error(`Failed to create account: ${accountError.message}`);
            }
        } else {
            console.log('[Onboarding] ‚úÖ Account created successfully');
        }
    } else {
        console.log('[Onboarding] ‚úÖ Account already exists');
    }
} catch (accountError) {
    console.error('[Onboarding] Error checking/creating account:', accountError);
    // Continue anyway - account might be created by trigger or API will handle it
}
```

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è** —á–µ—Ä–µ–∑ `signUp`
2. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ account** –≤ –ë–î
3. **–ï—Å–ª–∏ account –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** - —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é
4. **–ï—Å–ª–∏ account —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç** - –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
5. **–û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è** - –µ—Å–ª–∏ account —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∫–æ–Ω—Ñ–ª–∏–∫—Ç), –æ—à–∏–±–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã:
- `[Onboarding] User created: <userId>` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
- `[Onboarding] Account not found, creating...` - account –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ—Ç—Å—è
- `[Onboarding] ‚úÖ Account created successfully` - account —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ
- `[Onboarding] ‚úÖ Account already exists` - account —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

1. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ `/onboarding` –∏–ª–∏ `/ukr/onboarding`
   - –ü—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ —à–∞–≥–∏
   - –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:**
   ```
   [Onboarding] User created: <UUID>
   [Onboarding] Account not found, creating...
   [Onboarding] ‚úÖ Account created successfully
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î:**
   ```sql
   SELECT u.id, u.email, a.id as account_id 
   FROM auth.users u 
   LEFT JOIN public.accounts a ON u.id = a.id 
   WHERE u.email = 'your-email@example.com';
   ```
   
   –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ–±–µ –∑–∞–ø–∏—Å–∏ (user –∏ account).

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥:**
   - –í—ã–π–¥–∏—Ç–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
   - –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞ —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏
   - –î–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –≤–æ–π—Ç–∏

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–¢—Ä–∏–≥–≥–µ—Ä –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - —ç—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞, –Ω–µ –∑–∞–º–µ–Ω–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤** - –µ—Å–ª–∏ account —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ—à–∏–±–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
4. **Fallback** - –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ account –Ω–µ —É–¥–∞–ª–æ—Å—å, –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è (API endpoint —Ç–æ–∂–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å account)

## üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

–í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ:
1. –£–ª—É—á—à–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (ON CONFLICT DO NOTHING)
2. –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ account
3. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ —Ç—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª

