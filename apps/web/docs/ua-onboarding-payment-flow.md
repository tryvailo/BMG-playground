# Процесс онбординга и оплаты для украинской локали

## ✅ Реализованный функционал

### 1. Онбординг для UA пользователей

**Процесс:**
1. Пользователь проходит онбординг: выбирает регион (UA), город, вводит URL клиники, выбирает план
2. На шаге `account` создает аккаунт (email + пароль)
3. **Автоматически создается:**
   - ✅ Проект с данными онбординга (domain, region, city, clinicName)
   - ✅ Подписка со статусом `pending` и методом `manual`
   - ✅ Начальные данные для дашборда (12 месяцев weekly_stats)

**Код:** `app/api/projects/create-from-onboarding/route.ts` (строки 284-316)

### 2. Админ-панель для управления оплатами

**URL админ-панели:**
```
/admin/users
или
/[locale]/admin/users
```

**Примеры:**
- `http://localhost:3000/admin/users`
- `http://localhost:3000/en/admin/users`
- `http://localhost:3000/ukr/admin/users`

**Функционал:**
- ✅ Просмотр всех подписок пользователей
- ✅ Поиск по email, имени, номеру счета, плану
- ✅ Фильтрация по статусу (Pending, Paid, Failed, Canceled)
- ✅ Кнопка **"Mark as Paid"** для подписок со статусом `pending`
- ✅ Отображение информации о пользователе, плане, дате создания

**Код:** `app/[locale]/admin/users/page.tsx`

### 3. Отметка оплаты

**API endpoint:** `/api/subscriptions/mark-paid`

**Что происходит при отметке оплаты:**
1. Статус меняется с `pending` на `paid`
2. Устанавливается `paid_at` (дата оплаты)
3. Устанавливается `paid_by` (ID админа)
4. Обновляется `expires_at` (срок действия подписки)
5. Пользователь автоматически получает полный доступ ко всем функциям

**Код:** `app/api/subscriptions/mark-paid/route.ts`

## Как использовать

### Для продавца/админа:

1. **Откройте админ-панель:**
   ```
   http://localhost:3000/admin/users
   ```

2. **Найдите подписку клиента:**
   - Используйте поиск по email клиента
   - Или фильтруйте по статусу "Pending"

3. **Проверьте информацию:**
   - План: Starter/Growth/Enterprise
   - Цена: $99/$399/$499
   - Метод оплаты: Manual
   - Статус: **Pending** (желтый значок)

4. **После получения оплаты:**
   - Нажмите кнопку **"Mark as Paid"**
   - Подтвердите действие
   - Статус изменится на **Paid** (зеленый значок)
   - Клиент автоматически получит полный доступ

## Проверка работы

### Тестовый сценарий:

1. **Создайте тестового пользователя через онбординг:**
   - Перейдите на `/onboarding` или `/ukr/onboarding`
   - Выберите регион: **Ukraine (UA)**
   - Выберите город
   - Введите URL клиники
   - Выберите план (Starter/Growth)
   - Создайте аккаунт (email + пароль)

2. **Проверьте создание подписки:**
   - Откройте `/admin/users`
   - Найдите созданного пользователя
   - Должна быть подписка со статусом **Pending**

3. **Отметьте оплату:**
   - Нажмите "Mark as Paid"
   - Проверьте, что статус изменился на **Paid**

4. **Проверьте доступ пользователя:**
   - Войдите под созданным аккаунтом
   - Откройте `/home/settings`
   - Должен отображаться компонент `SubscriptionStatus` с статусом **Active**

## Структура данных подписки

```typescript
{
  id: "uuid",
  account_id: "user-uuid",
  plan_id: "starter" | "growth" | "enterprise",
  plan_name: "Starter" | "Growth" | "Enterprise",
  price: 99 | 399 | 499,
  currency: "USD",
  billing_interval: "month" | "year",
  payment_method: "manual",  // Для UA
  payment_status: "pending" | "paid" | "failed" | "canceled",
  invoice_number: null,
  expires_at: null,  // Устанавливается при отметке оплаты
  paid_at: null,     // Устанавливается при отметке оплаты
  paid_by: null,     // UUID админа, который отметил оплату
  created_at: "2025-01-30T...",
  updated_at: "2025-01-30T..."
}
```

## ⚠️ Важно для продакшена

1. **Безопасность админ-панели:**
   - Сейчас любой авторизованный пользователь может зайти в `/admin/users`
   - В продакшене нужно добавить проверку роли админа
   - Добавить middleware или проверку в компоненте

2. **RLS политики:**
   - Убедиться, что RLS политики для `subscriptions` правильно настроены
   - Админы должны видеть все подписки, обычные пользователи - только свои

## Миграции базы данных

Все необходимые миграции созданы:

1. ✅ `20250130_add_subscriptions_table.sql` - таблица subscriptions
2. ✅ `20251129_add_ai_visibility.sql` - таблица projects
3. ✅ `20251201_add_dashboard_metrics.sql` - поля для weekly_stats
4. ✅ `20251202_seed_dashboard_data.sql` - начальные данные

Все миграции применены и готовы к использованию.




