# Админ-панель управления пользователями и оплатами

## Доступ к админ-панели

**URL**: `/admin/users` или `/[locale]/admin/users`

Например:
- `http://localhost:3000/admin/users`
- `http://localhost:3000/en/admin/users`
- `http://localhost:3000/ukr/admin/users`

## Функционал админ-панели

### 1. Просмотр всех подписок
- Список всех пользователей с их подписками
- Информация о плане, цене, методе оплаты
- Статус оплаты (Pending, Paid, Failed, Canceled)

### 2. Поиск и фильтрация
- Поиск по номеру счета, имени, email, плану
- Фильтрация по статусу оплаты

### 3. Отметка оплаты
- Кнопка **"Mark as Paid"** для подписок со статусом `pending` и методом `manual`
- После отметки:
  - Статус меняется на `paid`
  - Устанавливается `paid_at` (дата оплаты)
  - Устанавливается `paid_by` (ID админа, который отметил)
  - Обновляется `expires_at` (срок действия подписки)

### 4. Создание подписок
- Возможность создать подписку для пользователя вручную
- Полезно, если подписка не была создана автоматически при онбординге

## Как работает процесс для UA пользователей

### При онбординге:
1. Пользователь проходит онбординг (регион, город, домен, план)
2. На шаге `account` создает аккаунт (email + пароль)
3. **Автоматически создается подписка** со статусом `pending` и методом `manual`
4. Пользователь получает доступ в админку с ограниченным функционалом

### После онбординга:
1. Продавец выставляет счет клиенту (вне системы)
2. Клиент оплачивает счет
3. Продавец заходит в `/admin/users`
4. Находит подписку клиента (поиск по email/имени)
5. Нажимает **"Mark as Paid"**
6. Клиент автоматически получает полный доступ ко всем функциям

## Проверка реализации

### ✅ Реализовано:
1. ✅ Создание подписки `pending` при онбординге для UA (код в `onboarding/page.tsx`)
2. ✅ Админ-панель `/admin/users` для управления подписками
3. ✅ API endpoint `/api/subscriptions/mark-paid` для отметки оплаты
4. ✅ Система ограничения доступа на основе статуса подписки

### ⚠️ Требует настройки:
1. **Безопасность**: В продакшене нужно добавить проверку роли админа
   - Сейчас любой авторизованный пользователь может зайти в `/admin/users`
   - Нужно добавить проверку роли в `app/[locale]/admin/users/page.tsx` и `/api/subscriptions/mark-paid`

2. **RLS политики**: Убедиться, что RLS политики для `subscriptions` правильно настроены
   - Сейчас есть базовая политика `subscriptions_read_own` (пользователи видят только свои подписки)
   - Для админов нужно добавить отдельную политику или использовать service_role

## Пример использования

### Для продавца/админа:

1. Откройте `/admin/users`
2. Найдите подписку клиента:
   - Используйте поиск по email: `client@example.com`
   - Или фильтруйте по статусу "Pending"
3. Проверьте информацию:
   - План: Starter/Growth/Enterprise
   - Цена: $99/$399/$499
   - Метод оплаты: Manual
   - Статус: Pending
4. После получения оплаты:
   - Нажмите кнопку **"Mark as Paid"**
   - Подтвердите действие
   - Статус изменится на "Paid"
   - Клиент получит полный доступ

## Структура данных

```typescript
interface Subscription {
  id: string;
  account_id: string;        // UUID пользователя
  plan_id: string;           // 'starter', 'growth', 'enterprise'
  plan_name: string;         // 'Starter', 'Growth', 'Enterprise'
  price: number;            // 99, 399, 499
  currency: string;          // 'USD'
  billing_interval: string;  // 'month' или 'year'
  payment_method: string;    // 'stripe' или 'manual'
  payment_status: string;   // 'pending', 'paid', 'failed', 'canceled'
  invoice_number: string | null;
  expires_at: string | null;
  paid_at: string | null;
  paid_by: string | null;    // UUID админа
  created_at: string;
  updated_at: string;
}
```




