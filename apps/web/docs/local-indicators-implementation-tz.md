# Техническое задание: Реализация альтернативных решений для Local Indicators

## Обзор

Документ описывает техническое задание и логику реализации комбинированного подхода для пунктов 6.2 (Реакция на отзывы) и 6.4 (Local Backlinks) без использования платных API (Ahrefs/SEMrush).

---

## 1. DOC.ua и Helsi через Firecrawl (Приоритет 1)

### 1.1. Требования

**Цель:** Получить данные об отзывах и ответах клиники на платформах DOC.ua и Helsi без использования их API.

**Функциональные требования:**
1. Найти страницу клиники на DOC.ua по названию и городу
2. Найти страницу клиники на Helsi по названию и городу
3. Парсить страницы с отзывами через Firecrawl
4. Извлечь:
   - Общее количество отзывов
   - Количество отзывов с ответами клиники
   - Количество отзывов, на которые ответили в течение 24 часов
   - Количество негативных отзывов (рейтинг < 3)
   - Количество негативных отзывов с ответами

**Нефункциональные требования:**
- Использовать существующий Firecrawl API клиент
- Обработка ошибок (страница не найдена, недоступна)
- Таймауты для запросов (30 секунд)
- Кэширование результатов (опционально)

### 1.2. Логика реализации

#### Шаг 1: Поиск URL страницы клиники

**DOC.ua:**
```
1. Поиск: "название клиники" + "город" site:doc.ua
2. Альтернатива: прямой поиск через Google Custom Search API
3. Парсинг результатов поиска для получения URL страницы клиники
```

**Helsi:**
```
1. Поиск: "название клиники" + "город" site:helsi.me
2. Альтернатива: прямой поиск через Google Custom Search API
3. Парсинг результатов поиска для получения URL страницы клиники
```

#### Шаг 2: Парсинг страницы через Firecrawl

```typescript
1. Использовать Firecrawl для получения HTML страницы
2. Парсить HTML для извлечения:
   - Секция с отзывами
   - Каждый отзыв (текст, рейтинг, дата, автор)
   - Ответ клиники (если есть)
   - Дата ответа
```

#### Шаг 3: Анализ отзывов

```typescript
1. Подсчитать общее количество отзывов
2. Определить отзывы с ответами клиники
3. Вычислить время ответа (разница между датой отзыва и ответа)
4. Подсчитать отзывы, на которые ответили в течение 24 часов
5. Определить негативные отзывы (рейтинг < 3)
6. Подсчитать негативные отзывы с ответами
```

#### Шаг 4: Интеграция в существующую систему

```typescript
1. Обновить функцию analyzeReviewResponse()
2. Добавить вызовы парсеров для DOC.ua и Helsi
3. Объединить результаты с данными из Google Places API
4. Вернуть структурированные данные согласно типам
```

### 1.3. Структура данных

```typescript
interface ReviewPlatformData {
  platform: 'doc_ua' | 'helsi';
  total_reviews: number;
  responded_reviews: number;
  response_rate_percent: number;
  responded_within_24h: number;
  response_rate_24h_percent: number;
  negative_reviews_count: number;
  negative_reviews_responded: number;
  negative_response_rate_percent: number;
  last_review_date?: string;
  average_response_time_hours?: number;
}
```

### 1.4. Обработка ошибок

- **Страница не найдена:** Возвращать нулевые значения, не прерывать выполнение
- **Firecrawl ошибка:** Логировать ошибку, возвращать нулевые значения
- **Таймаут:** Прерывать запрос через 30 секунд, возвращать частичные данные если есть

---

## 2. Local Backlinks через Google Custom Search (Приоритет 2)

### 2.1. Требования

**Цель:** Найти локальные бэклинки на сайт клиники без использования платных SEO API.

**Функциональные требования:**
1. Использовать Google Custom Search API для поиска упоминаний клиники
2. Фильтровать результаты по локальным доменам (того же города)
3. Проверять наличие ссылок на сайт клиники
4. Классифицировать источники по типам:
   - Городские порталы
   - Новостные сайты
   - Партнеры
   - Медицинские ассоциации
   - Благотворительные фонды
   - Локальные блогеры
5. Дедупликация результатов

**Нефункциональные требования:**
- Использовать бесплатный лимит Google Custom Search (100 запросов/день)
- Кэширование результатов поиска
- Обработка rate limits

### 2.2. Логика реализации

#### Шаг 1: Настройка Google Custom Search

```typescript
1. Создать Custom Search Engine в Google
2. Настроить поиск по всем сайтам (или ограничить регионом)
3. Получить API ключ и Search Engine ID
4. Сохранить в переменных окружения:
   - GOOGLE_CUSTOM_SEARCH_API_KEY
   - GOOGLE_CUSTOM_SEARCH_ENGINE_ID
```

#### Шаг 2: Поиск упоминаний клиники

```typescript
1. Поисковый запрос: "название клиники" + "город"
2. Выполнить запрос к Google Custom Search API
3. Получить результаты поиска (до 10 результатов за запрос)
4. Для каждого результата:
   - Извлечь URL
   - Извлечь домен
   - Проверить, является ли домен локальным (содержит название города)
```

#### Шаг 3: Проверка наличия ссылки

```typescript
1. Для каждого найденного URL:
   - Использовать Firecrawl для получения HTML страницы
   - Парсить HTML для поиска ссылок на сайт клиники
   - Извлечь anchor text ссылки
   - Определить тип ссылки (dofollow/nofollow)
2. Если ссылка найдена - добавить в список бэклинков
```

#### Шаг 4: Классификация источников

```typescript
1. Анализировать домен и URL для определения типа:
   - city_portal: содержит "city", "misto", "портал", "portal"
   - news: содержит "news", "новини", "медіа", "media"
   - partner: содержит "partner", "партнер"
   - association: содержит "association", "асоціація", "союз"
   - charity: содержит "charity", "благодійність", "фонд"
   - blogger: содержит "blog", "блог", "blogger"
2. Если тип не определен - классифицировать как "other"
```

#### Шаг 5: Дедупликация и агрегация

```typescript
1. Удалить дубликаты по домену
2. Подсчитать уникальные локальные домены
3. Подсчитать бэклинки по типам
4. Вернуть структурированные данные
```

### 2.3. Структура данных

```typescript
interface LocalBacklink {
  domain: string;
  url: string;
  anchor_text?: string;
  is_local: boolean;
  type: 'city_portal' | 'news' | 'partner' | 'association' | 'charity' | 'blogger' | 'other';
  found_date: string;
}
```

### 2.4. Оптимизация запросов

- **Кэширование:** Кэшировать результаты поиска на 24 часа
- **Batch обработка:** Обрабатывать несколько URL одновременно (до 5 параллельных запросов)
- **Rate limiting:** Соблюдать лимит 100 запросов/день

---

## 3. Проверка известных источников (Приоритет 3)

### 3.1. Требования

**Цель:** Проверить наличие упоминаний клиники на известных локальных источниках.

**Функциональные требования:**
1. Составить список популярных локальных источников по городам
2. Для каждого источника проверить наличие упоминания клиники
3. Проверить наличие ссылки на сайт клиники
4. Классифицировать по типам источников

### 3.2. Логика реализации

#### Шаг 1: Создание базы известных источников

```typescript
// Структура данных для известных источников
interface KnownSource {
  domain: string;
  city: string;
  type: 'city_portal' | 'news' | 'partner' | 'association' | 'charity' | 'blogger';
  search_pattern?: string; // Паттерн для поиска на странице
}

// Примеры для Киева
const KYIV_SOURCES: KnownSource[] = [
  { domain: 'kyiv.ua', city: 'Киев', type: 'city_portal' },
  { domain: 'kyiv24.ua', city: 'Киев', type: 'news' },
  // ... другие источники
];
```

#### Шаг 2: Поиск упоминаний на источнике

```typescript
1. Для каждого известного источника:
   - Построить поисковый запрос на сайте источника
   - Использовать Firecrawl для получения результатов поиска
   - Или использовать Google Custom Search с ограничением по домену
2. Проверить наличие упоминания клиники в результатах
```

#### Шаг 3: Проверка ссылки

```typescript
1. Для найденных страниц с упоминанием:
   - Использовать Firecrawl для получения HTML
   - Парсить HTML для поиска ссылок на сайт клиники
   - Извлечь anchor text
2. Если ссылка найдена - добавить в список бэклинков
```

### 3.3. База известных источников

**Структура:**
- JSON файл с источниками по городам
- Возможность добавления новых источников через конфигурацию
- Приоритизация источников (проверять сначала популярные)

---

## 4. Интеграция в существующую систему

### 4.1. Обновление типов

```typescript
// Обновить ReviewResponsePlatformSchema
// Добавить поля для DOC.ua и Helsi

// Обновить LocalBacklinksSchema
// Добавить поле source: 'google_search' | 'known_source' | 'search_console'
```

### 4.2. Обновление функций анализа

**analyzeReviewResponse():**
```typescript
1. Получить отзывы из Google Places API (уже реализовано)
2. Парсить DOC.ua через Firecrawl
3. Парсить Helsi через Firecrawl
4. Объединить результаты
5. Рассчитать общие метрики
```

**analyzeLocalBacklinks():**
```typescript
1. Поиск через Google Custom Search
2. Проверка известных источников
3. Опционально: Google Search Console (если доступен)
4. Дедупликация и классификация
5. Возврат структурированных данных
```

### 4.3. Конфигурация

**Переменные окружения:**
```env
# Google Custom Search
GOOGLE_CUSTOM_SEARCH_API_KEY=your_key
GOOGLE_CUSTOM_SEARCH_ENGINE_ID=your_engine_id

# Firecrawl (уже есть)
FIRECRAWL_API_KEY=your_key

# Google Search Console (опционально)
GOOGLE_SEARCH_CONSOLE_CLIENT_ID=your_client_id
GOOGLE_SEARCH_CONSOLE_CLIENT_SECRET=your_client_secret
```

**Конфигурационные файлы:**
- `known-sources.json` - база известных источников
- `city-domains.json` - домены по городам для фильтрации

---

## 5. План реализации

### Этап 1: DOC.ua и Helsi (2-3 дня)

**День 1:**
- [ ] Создать парсер для DOC.ua
- [ ] Создать парсер для Helsi
- [ ] Интегрировать с Firecrawl
- [ ] Тестирование на реальных данных

**День 2:**
- [ ] Интеграция в analyzeReviewResponse()
- [ ] Обработка ошибок
- [ ] Тестирование

**День 3:**
- [ ] Оптимизация и рефакторинг
- [ ] Документация

### Этап 2: Local Backlinks через Google Custom Search (3-4 дня)

**День 1:**
- [ ] Настройка Google Custom Search Engine
- [ ] Создание клиента для Google Custom Search API
- [ ] Реализация поиска упоминаний

**День 2:**
- [ ] Реализация проверки ссылок через Firecrawl
- [ ] Классификация источников
- [ ] Дедупликация

**День 3:**
- [ ] Интеграция в analyzeLocalBacklinks()
- [ ] Кэширование результатов
- [ ] Обработка rate limits

**День 4:**
- [ ] Тестирование
- [ ] Оптимизация
- [ ] Документация

### Этап 3: Проверка известных источников (2 дня)

**День 1:**
- [ ] Создание базы известных источников
- [ ] Реализация проверки источников
- [ ] Интеграция с Firecrawl

**День 2:**
- [ ] Интеграция в analyzeLocalBacklinks()
- [ ] Тестирование
- [ ] Документация

---

## 6. Тестирование

### 6.1. Unit тесты

- Парсинг HTML отзывов DOC.ua
- Парсинг HTML отзывов Helsi
- Классификация источников
- Дедупликация бэклинков

### 6.2. Integration тесты

- Полный цикл анализа DOC.ua
- Полный цикл анализа Helsi
- Полный цикл поиска бэклинков
- Комбинированный анализ

### 6.3. Тестовые данные

- Тестовые клиники с известными страницами на DOC.ua/Helsi
- Тестовые сайты с известными бэклинками
- Моки для Google Custom Search API

---

## 7. Обработка ошибок и edge cases

### 7.1. DOC.ua/Helsi

- **Страница не найдена:** Возвращать нулевые значения
- **Изменение структуры HTML:** Логировать предупреждение, использовать fallback парсинг
- **Требуется авторизация:** Пропускать источник, логировать ошибку
- **Таймаут:** Прерывать через 30 секунд

### 7.2. Google Custom Search

- **Rate limit:** Кэшировать результаты, использовать очередь запросов
- **Нет результатов:** Возвращать пустой массив
- **Ошибка API:** Логировать, возвращать частичные результаты

### 7.3. Firecrawl

- **Ошибка парсинга:** Логировать, пропускать страницу
- **Payment required:** Логировать предупреждение, возвращать частичные данные
- **Таймаут:** Прерывать через 30 секунд

---

## 8. Производительность

### 8.1. Оптимизация

- **Параллельные запросы:** До 5 одновременных запросов к Firecrawl
- **Кэширование:** Кэшировать результаты поиска на 24 часа
- **Ленивая загрузка:** Загружать данные только при необходимости

### 8.2. Лимиты

- Google Custom Search: 100 запросов/день
- Firecrawl: согласно тарифному плану
- Таймауты: 30 секунд на запрос

---

## 9. Мониторинг и логирование

### 9.1. Логирование

- Успешные запросы к DOC.ua/Helsi
- Найденные бэклинки
- Ошибки парсинга
- Rate limit предупреждения

### 9.2. Метрики

- Количество успешных парсингов
- Количество найденных бэклинков
- Время выполнения анализа
- Количество ошибок

---

## 10. Документация

### 10.1. Техническая документация

- Описание API функций
- Примеры использования
- Структура данных

### 10.2. Пользовательская документация

- Как настроить Google Custom Search
- Как добавить известные источники
- Интерпретация результатов

---

## Заключение

Данное ТЗ описывает полную реализацию альтернативных решений для Local Indicators без использования платных API. Реализация разбита на этапы с четкими задачами и сроками.

**Ключевые преимущества:**
- ✅ Не требует платных API (Ahrefs/SEMrush)
- ✅ Использует существующие инструменты (Firecrawl)
- ✅ Масштабируемое решение
- ✅ Гибкая конфигурация

**Риски:**
- ⚠️ Изменение структуры HTML на DOC.ua/Helsi потребует обновления парсеров
- ⚠️ Лимиты Google Custom Search (100 запросов/день)
- ⚠️ Зависимость от доступности Firecrawl API








